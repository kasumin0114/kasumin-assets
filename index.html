<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Kasumin Order</title>
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{background:#0d0b1a;display:flex;justify-content:center;align-items:center;min-height:100vh;font-family:'DotGothic16',monospace;padding:8px;}
.game-wrap{position:relative;width:100%;max-width:420px;height:min(680px,100svh);overflow:hidden;border:2px solid rgba(255,255,255,0.2);box-shadow:0 0 40px rgba(180,120,255,0.3);}
.bg{position:absolute;inset:0;background:url('https://cdn.jsdelivr.net/gh/kasumin0114/kasumin-assets@main/atelier.png') center/cover no-repeat;}
.bg-overlay{position:absolute;inset:0;background:linear-gradient(to bottom,rgba(10,8,25,0.65) 0%,rgba(10,8,25,0.3) 40%,rgba(10,8,25,0.45) 100%);}
.screen{position:absolute;inset:0;display:none;flex-direction:column;padding:16px;overflow-y:auto;}
.screen.show{display:flex;animation:fi 0.25s ease;}
@keyframes fi{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
.scr-title{font-size:clamp(14px,3.5vw,17px);color:#e0c0ff;text-align:center;margin-bottom:8px;letter-spacing:0.12em;line-height:1.5;}
.scr-sub{font-size:clamp(10px,2.5vw,12px);color:#aa88bb;text-align:center;margin-bottom:18px;line-height:1.6;}
.lang-grid{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:20px;max-width:300px;margin-left:auto;margin-right:auto;}
.lang-btn{background:rgba(255,255,255,0.1);border:2px solid rgba(200,160,255,0.4);border-radius:10px;padding:20px;cursor:pointer;text-align:center;transition:all 0.2s;}
.lang-btn:hover{border-color:rgba(255,150,200,0.7);background:rgba(255,180,220,0.2);transform:scale(1.02);}
.lang-flag{font-size:40px;display:block;margin-bottom:8px;}
.lang-name{font-size:16px;color:#fff;font-weight:700;}
.num-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px;}
.num-btn{background:rgba(255,255,255,0.08);border:2px solid rgba(200,160,255,0.3);border-radius:10px;padding:18px 12px;cursor:pointer;text-align:center;transition:all 0.2s;}
.num-btn:hover{border-color:rgba(255,150,200,0.6);background:rgba(255,180,220,0.15);}
.num-btn.on{border-color:#ff9ec8;background:rgba(255,130,190,0.25);box-shadow:0 0 12px rgba(255,150,200,0.4);}
.num-emoji{font-size:32px;display:block;margin-bottom:6px;}
.num-label{font-size:clamp(12px,3vw,14px);color:#fff;font-weight:700;display:block;margin-bottom:4px;}
.num-price{font-size:clamp(10px,2.5vw,12px);color:#ffaacc;}
.name-list{margin-bottom:14px;}
.name-item{margin-bottom:12px;}
.name-label{font-size:11px;color:#e0c0ff;margin-bottom:5px;display:block;}
.name-input{width:100%;border:2px solid rgba(200,160,255,0.35);border-radius:6px;padding:9px 12px;font-family:'DotGothic16',monospace;font-size:13px;color:#fff;background:rgba(255,255,255,0.06);}
.name-input:focus{outline:none;border-color:#ff9ec8;background:rgba(255,255,255,0.1);}
.name-input::placeholder{color:#888;}
.checkbox-big{margin-top:10px;padding:14px;background:rgba(255,150,200,0.15);border:2px solid rgba(255,150,200,0.5);border-radius:8px;display:flex;align-items:center;gap:12px;cursor:pointer;user-select:none;}
.checkbox-big input[type="checkbox"]{width:22px;height:22px;cursor:pointer;flex-shrink:0;}
.checkbox-big label{font-size:14px;color:#ffddee;cursor:pointer;font-weight:700;flex:1;line-height:1.4;}
.next-btn{width:100%;padding:12px;background:linear-gradient(135deg,#9060d0,#d060a0);border:none;border-radius:8px;color:white;font-family:'DotGothic16',monospace;font-size:clamp(12px,3vw,14px);font-weight:700;cursor:pointer;letter-spacing:0.1em;box-shadow:0 4px 12px rgba(192,96,160,0.5);transition:all 0.2s;}
.next-btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(192,96,160,0.6);}
.next-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
#main{position:absolute;inset:0;display:none;flex-direction:column;}
#main.show{display:flex;}
.char-area{display:flex;align-items:flex-end;padding:6px 12px 0;height:26%;position:relative;flex-shrink:0;}
.kasumin-img{height:100%;width:auto;max-width:32%;object-fit:contain;object-position:bottom;filter:drop-shadow(3px 4px 8px rgba(0,0,0,0.6));flex-shrink:0;margin-bottom:-2px;}
.dialog{flex:1;background:rgba(8,6,20,0.9);border:2px solid rgba(200,160,255,0.6);border-radius:6px;padding:7px 11px;margin-left:8px;margin-bottom:6px;position:relative;}
.dialog::before{content:'';position:absolute;left:-10px;top:50%;transform:translateY(-50%);border:5px solid transparent;border-right-color:rgba(200,160,255,0.6);}
.dialog-name{font-size:10px;color:#e0c0ff;margin-bottom:3px;letter-spacing:0.1em;}
.dialog-text{font-size:clamp(10px,2.5vw,12px);color:#fff;line-height:1.45;letter-spacing:0.03em;}
.blink{display:inline-block;animation:bk 1s step-end infinite;color:#e0c0ff;}
@keyframes bk{0%,100%{opacity:1;}50%{opacity:0;}}
.choice-wrap{margin-top:6px;}
.choice-btn{display:block;background:transparent;border:none;color:#fff;font-family:'DotGothic16',monospace;font-size:clamp(10px,2.5vw,12px);cursor:pointer;padding:2px;text-align:left;letter-spacing:0.05em;transition:color 0.1s;width:100%;}
.choice-btn.on{color:#ffccee;}
.choice-arrow{display:inline-block;animation:arrow-blink 0.7s step-end infinite;}
@keyframes arrow-blink{0%,100%{opacity:1;}50%{opacity:0;}}
.choice-btn:not(.on)::before{content:'ã€€';}
.char-area{display:flex;align-items:flex-end;padding:6px 12px 0;height:34%;position:relative;flex-shrink:0;}
.dialog-wrap{flex:1;display:flex;flex-direction:column;margin-left:8px;margin-bottom:18px;gap:6px;position:relative;}
.dialog{background:rgba(8,6,20,0.9);border:2px solid rgba(200,160,255,0.6);border-radius:6px;padding:10px 13px;position:relative;}
.dialog::before{content:'';position:absolute;left:-10px;top:50%;transform:translateY(-50%);border:5px solid transparent;border-right-color:rgba(200,160,255,0.6);}
.dialog-small{background:rgba(8,6,20,0.88);border:1.5px solid rgba(255,150,200,0.6);border-radius:6px;padding:6px 10px;position:absolute;bottom:-44px;right:0px;min-width:90px;max-width:55%;z-index:5;}
.dialog-small::after{content:'';position:absolute;right:12px;bottom:-9px;border:5px solid transparent;border-top-color:rgba(255,150,200,0.6);}
.dialog-name{font-size:10px;color:#e0c0ff;margin-bottom:3px;letter-spacing:0.1em;}
.dialog-text{font-size:clamp(10px,2.5vw,12px);color:#fff;line-height:1.45;letter-spacing:0.03em;}
.btn-grid{flex:1;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:6px;padding:6px 10px 100px;}
.menu-card{border-radius:8px;cursor:pointer;overflow:hidden;position:relative;border:2px solid rgba(255,255,255,0.25);transition:all 0.15s;background:rgba(0,0,0,0.15);}
.menu-card:hover{border-color:rgba(255,180,220,0.7);transform:scale(1.03);box-shadow:0 4px 16px rgba(255,150,200,0.4);}
.menu-card.has-sel{border-color:rgba(255,150,200,0.8);}
.card-bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0.7;}
.menu-card:hover .card-bg{opacity:0.85;}
.card-label{position:absolute;bottom:0;left:0;right:0;background:rgba(8,6,20,0.75);padding:4px 7px;display:flex;align-items:center;justify-content:space-between;}
.card-name{font-size:clamp(9px,2.2vw,11px);color:#fff;letter-spacing:0.05em;}
.card-price{font-size:clamp(7px,1.8vw,9px);color:#ffaacc;}
.card-check{font-size:9px;color:#ff9ec8;}
.sel-badge{position:absolute;top:4px;right:5px;background:rgba(255,100,180,0.9);color:white;font-size:8px;border-radius:3px;padding:1px 4px;letter-spacing:0.05em;display:none;}
.menu-card.has-sel .sel-badge{display:block;}
.sub{position:absolute;inset:0;background:rgba(8,6,20,0.97);display:none;flex-direction:column;overflow:hidden;}
.sub.show{display:flex;animation:fi 0.2s ease;}
.sub-hdr{display:flex;align-items:center;padding:10px 12px;border-bottom:1px solid rgba(200,160,255,0.2);gap:7px;flex-shrink:0;background:rgba(8,6,20,0.95);position:sticky;top:0;z-index:10;}
.sub-ttl{font-size:clamp(11px,2.8vw,14px);color:#e0c0ff;letter-spacing:0.1em;}
.back{margin-left:auto;background:rgba(200,160,255,0.15);border:1px solid rgba(200,160,255,0.4);border-radius:4px;color:#e0c0ff;font-family:'DotGothic16',monospace;font-size:clamp(9px,2.2vw,10px);padding:4px 10px;cursor:pointer;}
.back:hover{background:rgba(200,160,255,0.3);}
.sub-content{flex:1;overflow-y:auto;padding:12px;}
.player-indicator{font-size:13px;color:#ffccee;margin-bottom:12px;text-align:center;padding:10px;background:rgba(255,150,200,0.25);border:2px solid rgba(255,150,200,0.6);border-radius:6px;font-weight:700;position:sticky;top:0;z-index:5;}
.opt-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:7px;margin-bottom:12px;}
.opt-grid.col3{grid-template-columns:repeat(3,1fr);gap:6px;}
.opt-btn{background:rgba(255,255,255,0.07);border:1.5px solid rgba(255,255,255,0.15);border-radius:7px;padding:10px 6px;cursor:pointer;text-align:center;transition:all 0.15s;display:flex;flex-direction:column;align-items:center;gap:4px;position:relative;}
.opt-btn:hover{background:rgba(255,180,220,0.18);border-color:rgba(255,150,200,0.5);}
.opt-btn.on{background:rgba(255,130,190,0.28);border-color:#ff9ec8;box-shadow:0 0 8px rgba(255,150,200,0.4);}
.opt-btn.on::after{content:'âœ“';position:absolute;top:4px;right:6px;font-size:10px;color:#ff9ec8;}
.opt-e{font-size:clamp(16px,4vw,22px);line-height:1;}
.opt-l{font-family:'DotGothic16',monospace;font-size:clamp(9px,2.2vw,11px);color:#fff;line-height:1.3;}
.opt-p{font-size:clamp(7px,1.8vw,9px);color:#ffaacc;}
.section-title{font-size:12px;color:#e0c0ff;margin:12px 0 8px;padding-bottom:5px;border-bottom:1px solid rgba(200,160,255,0.15);letter-spacing:0.1em;}
.decide-btn{margin-top:12px;flex-shrink:0;background:linear-gradient(135deg,#9060d0,#d060a0);border:none;border-radius:7px;color:white;font-family:'DotGothic16',monospace;font-size:clamp(11px,2.8vw,13px);padding:11px;cursor:pointer;letter-spacing:0.1em;box-shadow:0 4px 12px rgba(192,96,160,0.4);transition:all 0.2s;}
.decide-btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(192,96,160,0.6);}
.pet-list{margin-bottom:10px;}
.pet-item{margin-bottom:10px;padding:10px;background:rgba(255,255,255,0.05);border:1.5px solid rgba(200,160,255,0.2);border-radius:6px;}
.pet-label{font-size:10px;color:#e0c0ff;margin-bottom:4px;display:block;}
.pet-input{width:100%;border:2px solid rgba(200,160,255,0.35);border-radius:6px;padding:8px 11px;font-family:'DotGothic16',monospace;font-size:12px;color:#fff;background:rgba(255,255,255,0.06);}
.pet-input:focus{outline:none;border-color:#ff9ec8;background:rgba(255,255,255,0.1);}
.add-pet-btn{width:100%;padding:8px;background:rgba(200,160,255,0.15);border:1.5px dashed rgba(200,160,255,0.5);border-radius:6px;color:#e0c0ff;font-family:'DotGothic16',monospace;font-size:11px;cursor:pointer;transition:all 0.2s;}
.add-pet-btn:hover{background:rgba(200,160,255,0.25);border-color:rgba(200,160,255,0.8);}
.free-area{background:rgba(8,6,20,0.92);border-top:2px solid rgba(200,160,255,0.3);padding:9px 11px;display:none;flex-direction:column;gap:7px;}
.free-area.show{display:flex;}
.free-ttl{font-size:11px;color:#e0c0ff;letter-spacing:0.1em;}
.free-input{width:100%;border:1.5px solid rgba(200,160,255,0.3);border-radius:6px;padding:7px 9px;font-family:'DotGothic16',monospace;font-size:11px;color:#fff;background:rgba(255,255,255,0.05);resize:vertical;min-height:65px;line-height:1.5;}
.free-input:focus{outline:none;border-color:#ff9ec8;background:rgba(255,255,255,0.08);}
.free-input::placeholder{color:#888;}
.free-close{background:transparent;border:1px solid rgba(200,160,255,0.3);border-radius:4px;color:#e0c0ff;font-family:'DotGothic16',monospace;font-size:9px;padding:4px 11px;cursor:pointer;align-self:flex-end;}
#result{position:absolute;inset:0;background:rgba(8,6,20,0.98);display:none;flex-direction:column;padding:13px;overflow-y:auto;}
#result.show{display:flex;animation:fi 0.3s ease;}
.res-ttl{font-size:clamp(12px,3.2vw,15px);color:#e0c0ff;text-align:center;margin-bottom:3px;letter-spacing:0.15em;}
.res-sub{font-size:clamp(8px,2.2vw,10px);color:#9070aa;text-align:center;margin-bottom:11px;}
.res-items{background:rgba(255,255,255,0.05);border:1px solid rgba(200,160,255,0.2);border-radius:7px;padding:9px;margin-bottom:9px;flex:1;}
.res-row{display:flex;align-items:flex-start;gap:7px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.07);}
.res-row:last-child{border-bottom:none;}
.res-icon{font-size:14px;flex-shrink:0;width:18px;text-align:center;margin-top:1px;}
.res-label{font-size:clamp(7px,1.8vw,9px);color:#9070aa;display:block;margin-bottom:2px;}
.res-val{font-size:clamp(9px,2.3vw,11px);color:#fff;line-height:1.4;}
.edit-btn{background:rgba(200,160,255,0.2);border:1px solid rgba(200,160,255,0.5);border-radius:4px;color:#e0c0ff;font-family:'DotGothic16',monospace;font-size:9px;padding:3px 7px;cursor:pointer;margin-left:auto;flex-shrink:0;transition:all 0.15s;}
.edit-btn:hover{background:rgba(200,160,255,0.35);}
.ss-hint{background:rgba(255,130,190,0.12);border:1.5px dashed rgba(255,130,190,0.5);border-radius:7px;padding:10px;text-align:center;margin-bottom:8px;animation:pulse 2s ease infinite;}
@keyframes pulse{0%,100%{border-color:rgba(255,130,190,0.5);}50%{border-color:rgba(255,130,190,1);box-shadow:0 0 10px rgba(255,130,190,0.25);}}
.ss-icon{font-size:26px;margin-bottom:3px;animation:bou 0.7s ease infinite alternate;}
@keyframes bou{from{transform:translateY(0);}to{transform:translateY(-5px);}}
.ss-text{font-size:clamp(9px,2.3vw,11px);color:#ffddee;line-height:1.5;}
.restart{width:100%;padding:9px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);border-radius:7px;color:#ccc;font-family:'DotGothic16',monospace;font-size:clamp(9px,2.3vw,11px);cursor:pointer;letter-spacing:0.05em;transition:all 0.2s;}
.restart:hover{background:rgba(255,255,255,0.15);color:#fff;}
.req-choice-grid{display:flex;flex-direction:column;gap:10px;padding:0 10px;}
.req-choice-card{border-radius:12px;cursor:pointer;padding:18px;border:2px solid rgba(200,160,255,0.4);background:rgba(255,255,255,0.08);transition:all 0.2s;display:flex;align-items:center;gap:14px;}
.req-choice-card:hover{border-color:rgba(255,150,200,0.8);background:rgba(255,150,200,0.18);transform:scale(1.02);}
.req-choice-card.free{border-color:rgba(255,180,100,0.5);background:rgba(255,160,60,0.1);}
.req-choice-card.free:hover{border-color:rgba(255,200,80,0.9);background:rgba(255,180,60,0.22);}
.req-choice-icon{font-size:34px;flex-shrink:0;}
.req-choice-title{font-size:clamp(12px,3vw,14px);color:#fff;font-weight:700;display:block;margin-bottom:4px;}
.req-choice-desc{font-size:clamp(9px,2.2vw,10px);color:#bb99dd;line-height:1.4;}
</style>
</head>
<body>
<div class="game-wrap">
<div class="bg"></div><div class="bg-overlay"></div>

<div class="screen" id="scr-lang">
  <div class="scr-title">è¨€èªã‚’é¸ã‚“ã§ã­ï¼</div>
  <div class="scr-sub">Please select your language</div>
  <div class="lang-grid">
    <div class="lang-btn" onclick="selectLang('ja')"><span class="lang-flag">ğŸ‡¯ğŸ‡µ</span><span class="lang-name">æ—¥æœ¬èª</span></div>
    <div class="lang-btn" onclick="selectLang('en')"><span class="lang-flag">ğŸ‡¬ğŸ‡§</span><span class="lang-name">English</span></div>
  </div>
</div>

<div class="screen" id="scr-num">
  <div class="scr-title" id="num-title"></div>
  <div class="scr-sub" id="num-sub"></div>
  <div class="num-grid" id="num-grid"></div>
  <button class="next-btn" id="num-next" disabled onclick="goToNames()"></button>
</div>

<div class="screen" id="scr-names">
  <div class="scr-title" id="name-title"></div>
  <div class="scr-sub" id="name-sub"></div>
  <div class="name-list" id="name-list"></div>
  <div class="checkbox-big" onclick="toggleCheck()">
    <input type="checkbox" id="need-translate" onclick="event.stopPropagation()">
    <label for="need-translate" onclick="event.preventDefault()" id="translate-check"></label>
  </div>
  <button class="next-btn" style="margin-top:14px" onclick="goToMain()" id="name-next"></button>
</div>

<div id="main">
  <div class="char-area">
    <img class="kasumin-img" src="https://cdn.jsdelivr.net/gh/kasumin0114/kasumin-assets@main/kasumin.png" alt="Kasumin">
    <div class="dialog-wrap">
      <div class="dialog">
        <div class="dialog-name">âœ¦ Kasumin âœ¦</div>
        <div class="dialog-text" id="dtxt"></div>
      </div>
      <div class="dialog-small" id="choices">
        <button class="choice-btn on" onclick="showReqChoice()" id="choice-yes"></button>
        <button class="choice-btn" onclick="noReq()" id="choice-no"></button>
      </div>
    </div>
  </div>

  <!-- Yesé¸æŠå¾Œï¼šè‡ªç”± or é¸æŠè‚¢ -->

  <div id="req-choice-area" style="display:none;flex:1;display:none;flex-direction:column;justify-content:center;padding:10px 0;">
    <div class="req-choice-grid">
      <div class="req-choice-card free" onclick="goFreeForm()">
        <span class="req-choice-icon">âœ¨</span>
        <span>
          <span class="req-choice-title" id="choice-free-title"></span>
          <span class="req-choice-desc" id="choice-free-desc"></span>
        </span>
      </div>
      <div class="req-choice-card" onclick="showMenu()">
        <span class="req-choice-icon">ğŸ“‹</span>
        <span>
          <span class="req-choice-title" id="choice-menu-title"></span>
          <span class="req-choice-desc" id="choice-menu-desc"></span>
        </span>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ï¼ˆé¸æŠè‚¢ã‹ã‚‰é¸ã¶ ã‚’é¸ã‚“ã æ™‚ã ã‘è¡¨ç¤ºï¼‰ -->

  <div class="btn-grid" id="btn-grid" style="display:none;">
    <div class="menu-card" id="card-bg" onclick="openSub('bg')">
      <div class="card-label"><span class="card-name" id="bg-card-name"></span><span class="card-check" id="chk-bg"></span></div>
      <div class="sel-badge" id="badge-bg-sel"></div>
    </div>
    <div class="menu-card" id="card-costume" onclick="openCostume()">
      <div class="card-label"><span class="card-name" id="costume-card-name"></span><span class="card-price">+Â¥500</span><span class="card-check" id="chk-costume"></span></div>
      <div class="sel-badge" id="badge-costume-sel"></div>
    </div>
    <div class="menu-card" id="card-pet" onclick="openSub('pet')">
      <img class="card-bg" src="https://cdn.jsdelivr.net/gh/kasumin0114/kasumin-assets@main/pet.png" alt="pet">
      <div class="card-label"><span class="card-name" id="pet-card-name"></span><span class="card-price">1P price</span><span class="card-check" id="chk-pet"></span></div>
      <div class="sel-badge" id="badge-pet-sel"></div>
    </div>
    <div class="menu-card" id="card-mood" onclick="openMood()">
      <div class="card-label"><span class="card-name" id="mood-card-name"></span><span class="card-check" id="chk-mood"></span></div>
      <div class="sel-badge" id="badge-mood-sel"></div>
    </div>
  </div>

  <div class="free-area" id="free-area">
    <div class="free-ttl" id="free-title"></div>
    <textarea class="free-input" id="free-input"></textarea>
    <button class="free-close" onclick="toggleFree()" id="free-close-btn"></button>
  </div>
</div>

<div class="sub" id="sub-freeform">
  <div class="sub-hdr"><span class="sub-ttl" id="freeform-title"></span><button class="back" onclick="closeFreeForm()" id="freeform-back"></button></div>
  <div class="sub-content">
    <div class="scr-sub" id="freeform-sub" style="margin-bottom:14px;text-align:left;white-space:pre-line;"></div>
    <textarea class="free-input" id="freeform-input" style="min-height:130px;margin-bottom:12px;font-size:13px;"></textarea>
    <div id="freeform-price" style="background:rgba(255,150,200,0.1);border:1px solid rgba(255,150,200,0.3);border-radius:8px;padding:10px 12px;margin-bottom:8px;font-size:clamp(9px,2.2vw,11px);color:#ffccee;line-height:1.9;"></div>
    <div id="freeform-translate-hint" style="background:rgba(150,120,255,0.1);border:1px solid rgba(150,120,255,0.35);border-radius:8px;padding:9px 12px;margin-bottom:12px;font-size:clamp(9px,2.2vw,10px);color:#ccbbff;line-height:1.7;"></div>
    <button class="decide-btn" onclick="submitFreeForm()" id="freeform-decide"></button>
  </div>
</div>

<div class="sub" id="sub-bg">
  <div class="sub-hdr"><span class="sub-ttl" id="bg-title"></span><button class="back" onclick="closeSub('bg')" id="bg-back"></button></div>
  <div style="padding:6px 10px 0;flex-shrink:0;">
    <div style="background:rgba(8,6,20,0.85);border:1.5px solid rgba(200,160,255,0.5);border-radius:6px;padding:6px 10px;font-size:clamp(9px,2.2vw,10px);color:#e0c0ff;line-height:1.4;" id="bg-kasumin-msg"></div>
  </div>
  <div style="position:relative;flex:1;margin:6px 8px 0;overflow:hidden;border-radius:8px;border:2px solid rgba(200,160,255,0.3);min-height:0;">
    <img src="https://cdn.jsdelivr.net/gh/kasumin0114/kasumin-assets@main/map.png" style="width:100%;height:100%;object-fit:cover;object-position:center;display:block;">
    <div id="bg-spots"></div>
  </div>
  <div style="padding:6px 10px 8px;flex-shrink:0;display:flex;align-items:center;justify-content:space-between;gap:8px;">
    <div style="font-size:10px;color:#e0c0ff;flex:1;" id="bg-selected-label"></div>
    <button class="decide-btn" style="margin-top:0;padding:8px 18px;font-size:11px;flex-shrink:0;" onclick="closeSub('bg')" id="bg-decide"></button>
  </div>
  <!-- ãã®ä»–èƒŒæ™¯ã‚«ãƒ¼ãƒ‰ -->
  <div style="margin:0 8px 10px;border-radius:8px;border:1.5px solid rgba(255,180,100,0.5);background:rgba(255,150,50,0.1);padding:10px 12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:all 0.2s;" onclick="openSamplePopup('custom')" onmouseenter="this.style.background='rgba(255,150,50,0.2)'" onmouseleave="this.style.background='rgba(255,150,50,0.1)'">
    <div>
      <div style="font-size:12px;color:#ffddaa;font-weight:700;margin-bottom:3px;" id="bg-custom-title">ğŸ¨ ãã®ä»–ã®èƒŒæ™¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</div>
      <div style="font-size:10px;color:#cc9966;" id="bg-custom-desc">å‚è€ƒç”»åƒã‚’ãŠè¦‹ã›ãã ã•ã„</div>
    </div>
    <div style="font-size:13px;color:#ffaacc;font-weight:700;">+Â¥1,000</div>
  </div>
</div>

<div id="sample-popup" style="display:none;position:absolute;inset:0;background:rgba(8,6,20,0.95);z-index:50;flex-direction:column;align-items:center;justify-content:center;padding:16px;">
  <button onclick="closeSamplePopup()" style="position:absolute;top:12px;right:14px;background:transparent;border:none;color:#e0c0ff;font-size:22px;cursor:pointer;">âœ•</button>
  <div style="font-size:22px;margin-bottom:4px;" id="popup-emoji"></div>
  <div style="font-size:14px;color:#fff;font-weight:700;margin-bottom:10px;letter-spacing:0.08em;" id="popup-name"></div>
  <div style="width:100%;max-width:260px;border-radius:10px;overflow:hidden;border:2px solid rgba(200,160,255,0.4);margin-bottom:10px;background:rgba(255,255,255,0.05);min-height:140px;display:flex;align-items:center;justify-content:center;">
    <img id="popup-img" style="width:100%;display:block;" onerror="this.style.display='none';document.getElementById('popup-noimg').style.display='block'">
    <div id="popup-noimg" style="display:none;color:#888;font-size:11px;padding:20px;text-align:center;">ã‚µãƒ³ãƒ—ãƒ«æº–å‚™ä¸­ğŸ¨<br>Sample coming soon</div>
  </div>
  <div style="font-size:10px;color:#ffaacc;margin-bottom:14px;" id="popup-price"></div>
  <button onclick="selectBgFromPopup()" style="background:linear-gradient(135deg,#9060d0,#d060a0);border:none;border-radius:8px;color:white;font-family:'DotGothic16',monospace;font-size:12px;padding:11px 28px;cursor:pointer;letter-spacing:0.1em;box-shadow:0 4px 12px rgba(192,96,160,0.5);" id="popup-select-btn"></button>
</div>

<div class="sub" id="sub-costume">
  <div class="sub-hdr"><span class="sub-ttl" id="costume-title"></span><button class="back" onclick="backCostume()" id="costume-back"></button></div>
  <div class="sub-content">
    <div class="player-indicator" id="costume-player"></div>
    <div class="section-title" id="section-costume-title"></div>
    <div class="opt-grid" id="costume-grid"></div>
    <div class="section-title" id="section-item-title"></div>
    <div class="opt-grid col3" id="item-grid"></div>
    <button class="decide-btn" onclick="nextCostume()" id="costume-decide"></button>
  </div>
</div>

<div class="sub" id="sub-mood">
  <div class="sub-hdr"><span class="sub-ttl" id="mood-title"></span><button class="back" onclick="backMood()" id="mood-back"></button></div>
  <div class="sub-content">
    <div class="player-indicator" id="mood-player"></div>
    <div class="opt-grid col3" id="mood-grid"></div>
    <button class="decide-btn" onclick="nextMood()" id="mood-decide"></button>
  </div>
</div>

<div class="sub" id="sub-pet">
  <div class="sub-hdr"><span class="sub-ttl" id="pet-title"></span><button class="back" onclick="closeSub('pet')" id="pet-back"></button></div>
  <div class="sub-content">
    <div class="scr-sub" style="margin-bottom:12px" id="pet-sub"></div>
    <div class="pet-list" id="pet-list">
      <div class="pet-item">
        <label class="pet-label" id="pet-label-1"></label>
        <input type="text" class="pet-input" id="pet-input-1">
      </div>
    </div>
    <button class="add-pet-btn" onclick="addPet()" id="add-pet-btn"></button>
    <button class="decide-btn" onclick="closeSub('pet')" id="pet-decide"></button>
  </div>
</div>

<div id="result">
  <div class="res-ttl" id="result-title"></div>
  <div class="res-sub" id="result-sub"></div>
  <div class="res-items" id="res-items"></div>
  <div class="ss-hint">
    <div class="ss-icon">ğŸ“±</div>
    <div class="ss-text" id="ss-text"></div>
    <div id="qr-wrap" style="margin-top:10px;display:flex;justify-content:center;align-items:center;background:#fff;border-radius:8px;padding:8px;width:fit-content;margin-left:auto;margin-right:auto;">
      <canvas id="qr-canvas"></canvas>
    </div>
  </div>
  <button class="restart" onclick="doRestart()" id="restart-btn"></button>
</div>

</div>

<script>
const BG={sakura:{ja:'æ¡œ',en:'Cherry Blossom',e:'ğŸŒ¸'},bluesky:{ja:'é’ç©º',en:'Blue Sky',e:'ğŸŒ¤ï¸'},fireworks:{ja:'èŠ±ç«',en:'Fireworks',e:'ğŸ†'},autumn:{ja:'ç´…è‘‰',en:'Autumn Leaves',e:'ğŸ‚'},fire:{ja:'ç«',en:'Fire',e:'ğŸ”¥'},thunder:{ja:'é›·',en:'Thunder',e:'âš¡'},flowers:{ja:'å­£ç¯€ã®èŠ±',en:'Season Flowers',e:'ğŸŒº'},sea:{ja:'æµ·',en:'Sea',e:'ğŸŒŠ'},bamboo:{ja:'ç«¹æ—',en:'Bamboo',e:'ğŸ‹'},water:{ja:'æ°´',en:'Water',e:'ğŸ’§'},custom:{ja:'ãã®ä»–èƒŒæ™¯',en:'Custom Background',e:'ğŸ¨',p:'+Â¥1,000'}};
const COS={none:{ja:'ãªã—',en:'None',e:'âœ¨'},kimono:{ja:'ç€ç‰©',en:'Kimono',e:'ğŸ‘˜'},ninja:{ja:'å¿è€…',en:'Ninja',e:'ğŸ¥·'},catear:{ja:'ã‚­ãƒ£ãƒƒãƒˆã‚¤ãƒ¤ãƒ¼',en:'Cat Ears',e:'ğŸ±'},uniform:{ja:'åˆ¶æœ',en:'Uniform',e:'ğŸ“'},other:{ja:'ãã®ä»–',en:'Other',e:'ğŸ“'},artist:{ja:'ä½œå®¶ã«ãŠä»»ã›',en:"Artist's Choice",e:'ğŸ²'}};
const ITM={none:{ja:'ãªã—',en:'None',e:'âœ¨'},sword:{ja:'åˆ€',en:'Sword',e:'ğŸ—¡ï¸'},kunai:{ja:'ããªã„',en:'Kunai',e:'ğŸ”ª'},shuriken:{ja:'æ‰‹è£å‰£',en:'Shuriken',e:'â­'},fire:{ja:'ãƒ•ã‚¡ã‚¤ãƒ¤ãƒ¼',en:'Fire',e:'ğŸ”¥'},thunder:{ja:'ã‚µãƒ³ãƒ€ãƒ¼',en:'Thunder',e:'âš¡'},flower:{ja:'èŠ±',en:'Flower',e:'ğŸŒ¸'},star:{ja:'æ˜Ÿ',en:'Star',e:'âœ¨'},book:{ja:'æœ¬',en:'Book',e:'ğŸ“–'},wand:{ja:'é­”æ³•ã®æ–',en:'Magic Wand',e:'ğŸª„'},other:{ja:'ãã®ä»–',en:'Other',e:'ğŸ’«'}};
const MOOD={default:{ja:'ãŠã¾ã‹ã›',en:'Default',e:'ğŸ²'},cute:{ja:'ã‚­ãƒ¥ãƒ¼ãƒˆ',en:'Cute',e:'ğŸŒ¸'},beauty:{ja:'ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£',en:'Beauty',e:'ğŸ’„'},cool:{ja:'ã‚¯ãƒ¼ãƒ«',en:'Cool',e:'âš¡'},handsome:{ja:'ãƒãƒ³ã‚µãƒ ',en:'Handsome',e:'âœ¨'},serious:{ja:'ã‚·ãƒªã‚¢ã‚¹',en:'Serious',e:'ğŸ—¡ï¸'},cheerful:{ja:'ãƒã‚¢ãƒ•ãƒ«',en:'Cheerful',e:'ğŸŒˆ'},mischief:{ja:'ã„ã˜ã‚ã‚‹',en:'Mischievous',e:'ğŸ˜ˆ'}};
const T={ja:{num_title:'äººæ•°ã‚’é¸ã‚“ã§ã­ï¼',num_sub:'âš ï¸ äºˆç´„æ™‚ã®äººæ•°ã‹ã‚‰å¤‰æ›´ã¯ã§ãã¾ã›ã‚“',num_people:['1äºº','2äºº','3äºº','4äºº'],name_title:'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åå‰ã‚’å…¥ã‚Œã¦ã­ï¼',name_sub:'ï¼ˆä¼¼é¡”çµµã«è¨˜å…¥ã™ã‚‹åå‰ã«ãªã‚Šã¾ã™ï¼‰',name_label:'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼',name_placeholder:'åå‰ã‚’å…¥åŠ›',translate_check:'â˜‘ï¸ æ—¥æœ¬èªã«å¤‰æ›ã—ã¦ã‚‚ã‚‰ã†',next_btn:'æ¬¡ã¸ â†’',kasumin_q:'ä½•ã‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã”ã–ã„ã¾ã™ã‹ï¼Ÿ',choice_yes:'Yes',choice_no:'No',choice_free:'âœ¨ è‡ªç”±ã«æã„ã¦ã»ã—ã„ï¼',choice_menu:'ğŸ“‹ é¸æŠè‚¢ã‹ã‚‰é¸ã¶',no_request:'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãªãã¦ã‚‚å¤§ä¸ˆå¤«ï¼ä½œå®¶ã«ãŠä»»ã›âœ¨',req_choice:'ã©ã‚“ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã”å¸Œæœ›ã§ã™ã‹ï¼Ÿ',select_category:'ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ã­ï¼',freeform_title:'âœ¨ è‡ªç”±ãƒªã‚¯ã‚¨ã‚¹ãƒˆ',freeform_sub:'ã©ã‚“ãªçµµã«ã—ã¦ã»ã—ã„ã‹ã€è‡ªç”±ã«æ•™ãˆã¦ã­ï¼\nè¨€èªã¯ãªã‚“ã§ã‚‚OKğŸŒ\nï¼ˆä¾‹ï¼šæ‚ªé­”ã«ã—ã¦ã»ã—ã„ã€ç•°ä¸–ç•Œã®é­”æ³•ä½¿ã„é¢¨ã«ã€ãªã©ï¼‰',freeform_decide:'é€ã‚‹ âœ“',freeform_back:'â† Back',bg_card:'Background',costume_card:'Costume',pet_card:'Pet',mood_card:'Mood',bg_title:'ğŸ—ºï¸ Background',costume_title:'ğŸ‘— Costume & Item',mood_title:'âœ¨ Mood',pet_title:'ğŸ¾ Pet',back_btn:'â† Back',decide_btn:'æ±ºå®š âœ“',section_costume:'Costume',section_item:'Item',pet_sub:'ãƒšãƒƒãƒˆã®åå‰ã‚’å…¥ã‚Œã¦ã­<br>å‚è€ƒç”»åƒã‚’è¤‡æ•°æšæŒã£ã¦ãã¦ã­ï¼',pet_label:'ãƒšãƒƒãƒˆ',pet_placeholder:'ä¾‹ï¼šãƒãƒã€Tama',add_pet_btn:'+ ãƒšãƒƒãƒˆã‚’è¿½åŠ ',free_title:'ğŸ’Œ ãã®ä»–ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆè‡ªç”±è¨˜å…¥ï¼‰',free_placeholder:'ä¸Šè¨˜ã«å½“ã¦ã¯ã¾ã‚‰ãªã„å½¢å¼ã§ã‚‚å¤§ä¸ˆå¤«ã§ã™ï¼ãªã‚“ã§ã‚‚æ›¸ã„ã¦ã­',free_close:'âœ“ é–‰ã˜ã‚‹',result_title:'âœ¦ Order Complete! âœ¦',result_sub:'KasuminãŒã‚ãªãŸã®ä¼¼é¡”çµµã‚’æãã¾ã™ğŸ¨',ss_text:'ã“ã®ãƒšãƒ¼ã‚¸ã‚’ã‚¹ã‚¯ã‚·ãƒ§ã—ã¦<br>ä½œå®¶ã•ã‚“ã«é€ã£ã¦ã­ğŸ€',restart_btn:'ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™',edit_btn:'âœï¸ ç·¨é›†',num_people_label:'äººæ•°',names_label:'åå‰',translate_label:'ç¿»è¨³',translate_yes:'æ—¥æœ¬èªã«å¤‰æ›å¸Œæœ›',bg_label:'Background',costume_label:'Costume&Item',mood_label:'Mood',pet_label_result:'Pet',other_label:'ãã®ä»–',free_req_label:'è‡ªç”±ãƒªã‚¯ã‚¨ã‚¹ãƒˆ',free_req_trans_label:'ç¿»è¨³ï¼ˆè‡ªå‹•ï¼‰',none:'ãªã—',default:'ãŠã¾ã‹ã›',player_costume:'ã®ã‚³ã‚¹ãƒãƒ¥ãƒ¼ãƒ ãƒ»ã‚¢ã‚¤ãƒ†ãƒ ',player_mood:'ã®ãƒ ãƒ¼ãƒ‰',select_costume:'ã®ã‚³ã‚¹ãƒãƒ¥ãƒ¼ãƒ ã‚’é¸ã‚“ã§ã­ğŸ‘—',select_mood:'ã®ãƒ ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­âœ¨',select_bg:'èƒŒæ™¯ã‚’é¸ã‚“ã§ã­ğŸ—ºï¸',select_pet:'ãƒšãƒƒãƒˆã®æƒ…å ±ã‚’å…¥ã‚Œã¦ã­ğŸ¾',select_free:'è‡ªç”±ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã­ğŸ’Œ',selected:'é¸æŠæ¸ˆã¿',people_suffix:'äºº',translating:'ç¿»è¨³ä¸­...'},en:{num_title:'Select Number of People',num_sub:'âš ï¸ Cannot be changed after booking',num_people:['1 Person','2 People','3 People','4 People'],name_title:'Enter Player Names',name_sub:'(Names to be written on the portrait)',name_label:'Player',name_placeholder:'Enter name',translate_check:'â˜‘ï¸ Translate to Japanese',next_btn:'Next â†’',kasumin_q:'Do you have any request?',choice_yes:'Yes',choice_no:'No',choice_free:'âœ¨ Free Request',choice_menu:'ğŸ“‹ Choose from options',no_request:'No requests needed! Leave it to the artistâœ¨',req_choice:'What style would you like?',select_category:'Select a category!',freeform_title:'âœ¨ Free Request',freeform_sub:'Tell me freely what kind of portrait you want!\nAny language is OKğŸŒ\n(e.g. Make me look like a demon, Fantasy wizard style, etc.)',freeform_decide:'Send âœ“',freeform_back:'â† Back',bg_card:'Background',costume_card:'Costume',pet_card:'Pet',mood_card:'Mood',bg_title:'ğŸ—ºï¸ Background',costume_title:'ğŸ‘— Costume & Item',mood_title:'âœ¨ Mood',pet_title:'ğŸ¾ Pet',back_btn:'â† Back',decide_btn:'Confirm âœ“',section_costume:'Costume',section_item:'Item',pet_sub:'Enter pet name<br>Please bring reference images!',pet_label:'Pet',pet_placeholder:'e.g., Pochi, Tama',add_pet_btn:'+ Add Pet',free_title:'ğŸ’Œ Other Requests (Free Text)',free_placeholder:'Any other requests are welcome!',free_close:'âœ“ Close',result_title:'âœ¦ Order Complete! âœ¦',result_sub:'Kasumin will draw your portraitğŸ¨',ss_text:'Take a screenshot and send it<br>to the artistğŸ€',restart_btn:'ğŸ”„ Start Over',edit_btn:'âœï¸ Edit',num_people_label:'Number of People',names_label:'Names',translate_label:'Translation',translate_yes:'Translate to Japanese',bg_label:'Background',costume_label:'Costume & Item',mood_label:'Mood',pet_label_result:'Pet',other_label:'Other Requests',free_req_label:'Free Request',free_req_trans_label:'Translation (auto)',none:'None',default:'Default',player_costume:"'s Costume & Item",player_mood:"'s Mood",select_costume:"'s costumeğŸ‘—",select_mood:"'s moodâœ¨",select_bg:'Select backgroundğŸ—ºï¸',select_pet:'Enter pet infoğŸ¾',select_free:'Write your requestsğŸ’Œ',selected:'Selected',people_suffix:' people',translating:'Translating...'}};

const MAP_SPOTS=[{key:'sakura',ja:'æ¡œ',en:'Cherry Blossom',e:'ğŸŒ¸',x:45,y:18,sample:'https://cdn.jsdelivr.net/gh/kasumin0114/kasumin-assets@main/sample_sakura.png'},{key:'thunder',ja:'é›·',en:'Thunder',e:'âš¡',x:72,y:18,sample:'https://cdn.jsdelivr.net/gh/kasumin0114/kasumin-assets@main/sample_thunder.png'},{key:'fireworks',ja:'èŠ±ç«',en:'Fireworks',e:'ğŸ†',x:22,y:28,sample:'https://cdn.jsdelivr.net/gh/kasumin0114/kasumin-assets@main/sample_fireworks.png'},{key:'bluesky',ja:'é’ç©º',en:'Blue Sky',e:'ğŸŒ¤ï¸',x:14,y:38,sample:'https://cdn.jsdelivr.net/gh/kasumin0114/kasumin-assets@main/sample_bluesky.png'},{key:'fire',ja:'ç«',en:'Fire',e:'ğŸ”¥',x:82,y:42,sample:'https://cdn.jsdelivr.net/gh/kasumin0114/kasumin-assets@main/sample_fire.png'},{key:'autumn',ja:'ç´…è‘‰',en:'Autumn Leaves',e:'ğŸ‚',x:12,y:52,sample:'https://cdn.jsdelivr.net/gh/kasumin0114/kasumin-assets@main/sample_autumn.png'},{key:'bamboo',ja:'ç«¹æ—',en:'Bamboo',e:'ğŸ‹',x:42,y:58,sample:null},{key:'flowers',ja:'å­£ç¯€ã®èŠ±',en:'Season Flowers',e:'ğŸŒº',x:13,y:72,sample:'https://cdn.jsdelivr.net/gh/kasumin0114/kasumin-assets@main/sample_flowers.png'},{key:'water',ja:'æ°´',en:'Water',e:'ğŸ’§',x:72,y:58,sample:null},{key:'sea',ja:'æµ·',en:'Sea',e:'ğŸŒŠ',x:58,y:75,sample:'https://cdn.jsdelivr.net/gh/kasumin0114/kasumin-assets@main/sample_sea.png'},{key:'custom',ja:'ãã®ä»–èƒŒæ™¯',en:'Custom Background',e:'ğŸ¨',x:0,y:0,sample:null}];
let currentPopupKey='';
const S={lang:'ja',numPlayers:0,names:[],needTranslate:false,bg:'',costume:[],item:[],pets:[],mood:[],free:'',freeFormText:'',freeFormTranslation:''};
let currentPlayer=0,petCount=1,editingMode=false;
function renderMapSpots(){
  const container=document.getElementById('bg-spots');
  if(!container)return;
  container.innerHTML='';
  MAP_SPOTS.forEach(sp=>{
    if(sp.key==='custom')return; // ãƒãƒƒãƒ—å¤–ã‚«ãƒ¼ãƒ‰ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—
    const btn=document.createElement('button');
    const isSel=S.bg===sp.key;
    const noSample=!sp.sample;
    btn.style.cssText=`position:absolute;left:${sp.x}%;top:${sp.y}%;transform:translate(-50%,-50%);background:${isSel?'rgba(255,100,170,0.9)':noSample?'rgba(80,80,80,0.65)':'rgba(8,6,20,0.78)'};border:${isSel?'2px solid #ff9ec8':'1.5px solid rgba(200,160,255,0.65)'};border-radius:20px;color:white;font-family:'DotGothic16',monospace;font-size:9px;padding:3px 7px;cursor:${noSample?'default':'pointer'};white-space:nowrap;transition:all 0.15s;display:flex;align-items:center;gap:3px;z-index:10;box-shadow:0 2px 6px rgba(0,0,0,0.5);`;
    btn.innerHTML=`<span style="font-size:12px">${sp.e}</span><span>${S.lang==='ja'?sp.ja:sp.en}</span>${isSel?'<span style="color:#ffccee;margin-left:2px;">âœ“</span>':''}`;
    if(true){  // å…¨ã‚¹ãƒãƒƒãƒˆã‚¿ãƒƒãƒ—å¯èƒ½
      btn.onmouseenter=()=>{if(S.bg!==sp.key)btn.style.background=noSample?'rgba(120,100,160,0.7)':'rgba(200,100,200,0.75)';};
      btn.onmouseleave=()=>{if(S.bg!==sp.key)btn.style.background=noSample?'rgba(80,80,80,0.65)':'rgba(8,6,20,0.78)';};
      btn.onclick=()=>openSamplePopup(sp.key);
    }
    container.appendChild(btn);
  });
  const sel=MAP_SPOTS.find(s=>s.key===S.bg);
  const lbl=document.getElementById('bg-selected-label');
  if(lbl){
    if(sel)lbl.innerHTML=`${sel.e} <b style="color:#fff">${S.lang==='ja'?sel.ja:sel.en}</b> <span style="color:#ffaacc">+Â¥0</span>`;
    else lbl.textContent=S.lang==='ja'?'âœ¦ ã‚¹ãƒãƒƒãƒˆã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸ã‚“ã§ã­ï¼':'âœ¦ Tap a spot to select!';
  }
  const msg=document.getElementById('bg-kasumin-msg');
  if(msg)msg.textContent=S.lang==='ja'?'ğŸ‘† ãƒãƒƒãƒ—ã®ã‚¹ãƒãƒƒãƒˆã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã‚µãƒ³ãƒ—ãƒ«ãŒè¦‹ã‚Œã‚‹ã‚ˆï¼ï¼ˆ+Â¥0ï¼‰':'ğŸ‘† Tap a spot on the map to see a sample! (+Â¥0)';
  const dec=document.getElementById('bg-decide');
  if(dec)dec.textContent=S.lang==='ja'?'æ±ºå®š âœ“':'Confirm âœ“';
  const ttl=document.getElementById('bg-title');
  if(ttl)ttl.textContent=S.lang==='ja'?'ğŸ—ºï¸ Background':'ğŸ—ºï¸ Background';
  const bk=document.getElementById('bg-back');
  if(bk)bk.textContent=S.lang==='ja'?'â† Back':'â† Back';
}
function openSamplePopup(key){
  const sp=MAP_SPOTS.find(s=>s.key===key);
  if(!sp)return;
  currentPopupKey=key;
  document.getElementById('popup-emoji').textContent=sp.e;
  document.getElementById('popup-name').textContent=S.lang==='ja'?sp.ja:sp.en;
  const img=document.getElementById('popup-img');
  const noimg=document.getElementById('popup-noimg');
  if(sp.sample){img.style.display='block';noimg.style.display='none';img.src=sp.sample;}
  else{img.style.display='none';noimg.style.display='block';noimg.innerHTML=S.lang==='ja'?'ã‚µãƒ³ãƒ—ãƒ«æº–å‚™ä¸­ğŸ¨<br><span style="font-size:9px;color:#aaa">Coming soon</span>':'Sample coming soonğŸ¨<br><span style="font-size:9px;color:#aaa">æº–å‚™ä¸­</span>';}
  const isCustom=key==='custom';
  document.getElementById('popup-price').textContent=isCustom?(S.lang==='ja'?'ãã®ä»–èƒŒæ™¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ +Â¥1,000':'Custom background +Â¥1,000'):(S.lang==='ja'?'èƒŒæ™¯è¿½åŠ æ–™é‡‘ +Â¥0':'Background fee +Â¥0');
  document.getElementById('popup-select-btn').textContent=S.lang==='ja'?'âœ¦ ã“ã‚Œã‚’é¸ã¶ï¼':'âœ¦ Select this!';
  document.getElementById('sample-popup').style.display='flex';
  const customTitle=document.getElementById('bg-custom-title');
  const customDesc=document.getElementById('bg-custom-desc');
  if(customTitle)customTitle.textContent=S.lang==='ja'?'ğŸ¨ ãã®ä»–ã®èƒŒæ™¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ':'ğŸ¨ Request a custom background';
  if(customDesc)customDesc.textContent=S.lang==='ja'?'å‚è€ƒç”»åƒã‚’ãŠè¦‹ã›ãã ã•ã„':'Please show a reference image';
}
function closeSamplePopup(){document.getElementById('sample-popup').style.display='none';currentPopupKey='';}
function selectBgFromPopup(){S.bg=currentPopupKey;closeSamplePopup();renderMapSpots();updateBadge('bg');checkShowBtn();}
function selectLang(l){S.lang=l;document.getElementById('scr-lang').classList.remove('show');document.getElementById('scr-num').classList.add('show');renderNumScreen();}
function renderNumScreen(){const t=T[S.lang];document.getElementById('num-title').textContent=t.num_title;document.getElementById('num-sub').textContent=t.num_sub;const g=document.getElementById('num-grid');g.innerHTML='';for(let i=0;i<4;i++){const n=i+1;g.innerHTML+=`<div class="num-btn" onclick="selectNum(${n})"><span class="num-emoji">${'ğŸ™‹'.repeat(n)}</span><span class="num-label">${t.num_people[i]}</span><span class="num-price">Â¥${[3000,5000,6000,7000][i].toLocaleString()}</span></div>`;}document.getElementById('num-next').textContent=t.next_btn;}
function toggleCheck(){const cb=document.getElementById('need-translate');cb.checked=!cb.checked;}
function selectNum(n){S.numPlayers=n;document.querySelectorAll('.num-btn').forEach(b=>b.classList.remove('on'));event.target.closest('.num-btn').classList.add('on');document.getElementById('num-next').disabled=false;}
function goToNames(){document.getElementById('scr-num').classList.remove('show');document.getElementById('scr-names').classList.add('show');const t=T[S.lang];document.getElementById('name-title').textContent=t.name_title;document.getElementById('name-sub').textContent=t.name_sub;document.getElementById('translate-check').textContent=t.translate_check;document.getElementById('name-next').textContent=t.next_btn;const list=document.getElementById('name-list');list.innerHTML='';for(let i=0;i<S.numPlayers;i++){list.innerHTML+=`<div class="name-item"><label class="name-label">${t.name_label}${i+1}</label><input type="text" class="name-input" id="name-${i}" placeholder="${t.name_placeholder}"></div>`;}}
function goToMain(){S.names=[];for(let i=0;i<S.numPlayers;i++)S.names.push(document.getElementById('name-'+i).value||'Player '+(i+1));S.needTranslate=document.getElementById('need-translate').checked;if(!editingMode){S.costume=Array(S.numPlayers).fill(null).map(()=>[]);S.item=Array(S.numPlayers).fill(null).map(()=>[]);S.mood=Array(S.numPlayers).fill(null).map(()=>[]);}document.getElementById('scr-names').classList.remove('show');if(editingMode){editingMode=false;showResult();}else{renderMainScreen();document.getElementById('main').classList.add('show');}}
function renderMainScreen(){const t=T[S.lang];document.getElementById('dtxt').innerHTML=t.kasumin_q+'<span class="blink">â–®</span>';document.getElementById('choices').style.display='';document.getElementById('req-choice-area').style.display='none';document.getElementById('btn-grid').style.display='none';document.getElementById('choice-yes').innerHTML='<span class="choice-arrow">â–¶</span> '+t.choice_yes;document.getElementById('choice-no').innerHTML='<span style="opacity:0">â–¶</span> '+t.choice_no;document.getElementById('choice-free-title').textContent=S.lang==='ja'?'è‡ªç”±ã«ã‚ªãƒ¼ãƒ€ãƒ¼ã™ã‚‹':'Free Order';document.getElementById('choice-free-desc').textContent=S.lang==='ja'?'æ‚ªé­”ã«ã—ãŸã„ã€ç•°ä¸–ç•Œé¢¨ã«â€¦ãªã©è‡ªç”±ã«ä¼ãˆã¦ã­ï¼':'Tell me freely! e.g. demon style, fantasy world...';document.getElementById('choice-menu-title').textContent=S.lang==='ja'?'é¸æŠè‚¢ã‹ã‚‰é¸ã¶':'Choose from options';document.getElementById('choice-menu-desc').textContent=S.lang==='ja'?'èƒŒæ™¯ãƒ»ã‚³ã‚¹ãƒãƒ¥ãƒ¼ãƒ ãƒ»ãƒ ãƒ¼ãƒ‰ã‚’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰é¸æŠ':'Select background, costume & mood from menu';document.getElementById('bg-card-name').textContent=t.bg_card;document.getElementById('costume-card-name').textContent=t.costume_card;document.getElementById('pet-card-name').textContent=t.pet_card;document.getElementById('mood-card-name').textContent=t.mood_card;document.getElementById('badge-bg-sel').textContent=t.selected;document.getElementById('badge-costume-sel').textContent=t.selected;document.getElementById('badge-pet-sel').textContent=t.selected;document.getElementById('badge-mood-sel').textContent=t.selected;document.getElementById('free-title').textContent=t.free_title;document.getElementById('free-input').placeholder=t.free_placeholder;document.getElementById('free-close-btn').textContent=t.free_close;}
function setDialog(k){const t=T[S.lang];document.getElementById('dtxt').innerHTML=t[k]+'<span class="blink">â–®</span>';}
function showReqChoice(){const t=T[S.lang];document.getElementById('choices').style.display='none';document.getElementById('req-choice-area').style.display='flex';document.getElementById('dtxt').innerHTML=t.req_choice+'<span class="blink">â–®</span>';}
function showMenu(){document.getElementById('req-choice-area').style.display='none';document.getElementById('btn-grid').style.display='grid';setDialog('select_category');}
function beginOrder(){document.getElementById('choices').style.display='none';document.getElementById('req-choice-area').style.display='none';document.getElementById('btn-grid').style.display='grid';setDialog('select_category');}
function noReq(){setDialog('no_request');const cy=document.getElementById('choice-yes');const cn=document.getElementById('choice-no');cy.innerHTML='<span class="choice-arrow">â–¶</span> '+T[S.lang].choice_yes;cn.innerHTML='<span style="opacity:0">â–¶</span> '+T[S.lang].choice_no;document.getElementById('choices').style.display='';}
function goFreeForm(){const t=T[S.lang];document.getElementById('req-choice-area').style.display='none';document.getElementById('choices').style.display='none';document.getElementById('sub-freeform').classList.add('show');document.getElementById('freeform-title').textContent=t.freeform_title;document.getElementById('freeform-sub').textContent=t.freeform_sub;document.getElementById('freeform-decide').textContent=t.freeform_decide;document.getElementById('freeform-back').textContent=t.freeform_back;document.getElementById('freeform-input').placeholder=S.lang==='ja'?'ä¾‹ï¼šæ‚ªé­”ã«ã—ã¦ã»ã—ã„ã€ç•°ä¸–ç•Œã®é­”æ³•ä½¿ã„é¢¨ã«â€¦':'e.g. Make me look like a demon, Fantasy wizard style...';const price=document.getElementById('freeform-price');if(S.lang==='ja'){price.innerHTML='ğŸ‘— ã‚³ã‚¹ãƒãƒ¥ãƒ¼ãƒ ãƒã‚§ãƒ³ã‚¸ <span style="color:#ffaacc;font-weight:700;">+Â¥500</span><br>ğŸ¾ ãƒšãƒƒãƒˆè¿½åŠ  <span style="color:#ffaacc;font-weight:700;">ãŠã²ã¨ã‚Šæ§˜æ–™é‡‘ãƒ—ãƒ©ã‚¹</span>';}else{price.innerHTML='ğŸ‘— Costume change <span style="color:#ffaacc;font-weight:700;">+Â¥500</span><br>ğŸ¾ Pet add-on <span style="color:#ffaacc;font-weight:700;">+1 person fee</span>';}const hint=document.getElementById('freeform-translate-hint');if(S.lang==='ja'){hint.innerHTML='ğŸŒ <b>è¨€èªã¯ãªã‚“ã§ã‚‚OKï¼</b><br>è‡ªåˆ†ã®å›½ã®è¨€è‘‰ã§ãã®ã¾ã¾æ›¸ã„ã¦ã­ğŸŒ¸<br><span style="color:#aaa;font-size:9px;">ç¿»è¨³ã¯KasuminãŒè¡Œã„ã¾ã™</span>';}else{hint.innerHTML='ğŸŒ <b>Any language is OK!</b><br>Write freely in your own languageğŸŒ¸<br><span style="color:#aaa;font-size:9px;">Kasumin will handle the translation</span>';}}
function closeFreeForm(){document.getElementById('sub-freeform').classList.remove('show');document.getElementById('req-choice-area').style.display='flex';const t=T[S.lang];document.getElementById('dtxt').innerHTML=t.req_choice+'<span class="blink">â–®</span>';}
async function submitFreeForm(){const t=T[S.lang];const input=document.getElementById('freeform-input').value.trim();if(!input)return;S.freeFormText=input;S.freeFormTranslation='';document.getElementById('sub-freeform').classList.remove('show');showFreeFormResult();}
function showResult(){
// QRèª­ã¿è¾¼ã¿æ™‚ã¯pet-listãŒå­˜åœ¨ã—ãªã„ã®ã§æ¡ä»¶ä»˜ãã§å–å¾—
const petInputs=document.querySelectorAll('#pet-list .pet-input');
if(petInputs.length>0){S.pets=[];petInputs.forEach(inp=>{const v=inp.value.trim();if(v)S.pets.push(v);});}
const freeInp=document.getElementById('free-input');
if(freeInp)S.free=freeInp.value;
document.getElementById('main').classList.remove('show');
document.getElementById('scr-names').classList.remove('show');
document.querySelectorAll('.sub').forEach(s=>s.classList.remove('show'));
const fa=document.getElementById('free-area');if(fa)fa.classList.remove('show');
const fb=document.getElementById('fin-btn');if(fb)fb.style.display='none';
const t=T[S.lang];
// QRèª­ã¿è¾¼ã¿æ™‚ã¯costume/item/moodã®é…åˆ—é•·ã‚’numPlayersã«åˆã‚ã›ã‚‹
while(S.costume.length<S.numPlayers)S.costume.push([]);
while(S.item.length<S.numPlayers)S.item.push([]);
while(S.mood.length<S.numPlayers)S.mood.push([]);
document.getElementById('result-title').textContent=t.result_title;
document.getElementById('result-sub').textContent=t.result_sub;
document.getElementById('ss-text').innerHTML=S.lang==='ja'?'QRã‚³ãƒ¼ãƒ‰ã‚’Kasuminã«èª­ã¿è¾¼ã‚“ã§ã‚‚ã‚‰ã£ã¦ã­ğŸ“±':'Show this QR code to KasuminğŸ“±';
document.getElementById('restart-btn').textContent=t.restart_btn;
let html='';
// å…±æœ‰æƒ…å ±
html+=`<div class="res-row"><div class="res-icon">ğŸ‘¥</div><div style="flex:1"><span class="res-label">${t.num_people_label}</span><span class="res-val">${S.numPlayers}${t.people_suffix}</span></div></div>`;
if(S.needTranslate)html+=`<div class="res-row"><div class="res-icon">ğŸŒ</div><div><span class="res-label">${t.translate_label}</span><span class="res-val">${t.translate_yes}</span></div></div>`;
html+=`<div class="res-row"><div class="res-icon">ğŸ—ºï¸</div><div style="flex:1"><span class="res-label">${t.bg_label}</span><span class="res-val">${S.bg?BG[S.bg][S.lang]:t.none}</span></div><button class="edit-btn" onclick="editBg()">${t.edit_btn}</button></div>`;
html+=`<div class="res-row"><div class="res-icon">ğŸ¾</div><div style="flex:1"><span class="res-label">${t.pet_label_result}</span><span class="res-val">${S.pets.length?S.pets.join('ãƒ»'):t.none}</span></div><button class="edit-btn" onclick="editPet()">${t.edit_btn}</button></div>`;
html+=`<div class="res-row"><div class="res-icon">ğŸ’Œ</div><div style="flex:1"><span class="res-label">${t.other_label}</span><span class="res-val">${S.free||'ï¼ˆ'+t.none+'ï¼‰'}</span></div><button class="edit-btn" onclick="editFree()">${t.edit_btn}</button></div>`;
// äººç‰©ã”ã¨ã¾ã¨ã‚
for(let i=0;i<S.numPlayers;i++){
  const c=S.costume[i].length||S.item[i].length?[...S.costume[i].map(k=>COS[k][S.lang]),...S.item[i].map(k=>ITM[k][S.lang])].join('ãƒ»'):t.none;
  const m=S.mood[i].length?S.mood[i].map(k=>MOOD[k][S.lang]).join('ãƒ»'):t.default;
  html+=`<div style="background:rgba(255,150,200,0.08);border:1.5px solid rgba(255,150,200,0.35);border-radius:8px;padding:8px 10px;margin-top:8px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
      <span style="font-size:13px;color:#ffccee;font-weight:700;">ğŸ‘¤ ${S.names[i]}</span>
      <button class="edit-btn" onclick="editNames()">${t.edit_btn}</button>
    </div>
    <div style="font-size:10px;color:#9070aa;margin-bottom:2px;">${t.costume_label}</div>
    <div style="font-size:11px;color:#fff;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;">${c}<button class="edit-btn" onclick="editCostume(${i})">${t.edit_btn}</button></div>
    <div style="font-size:10px;color:#9070aa;margin-bottom:2px;">${t.mood_label}</div>
    <div style="font-size:11px;color:#fff;display:flex;justify-content:space-between;align-items:center;">${m}<button class="edit-btn" onclick="editMood(${i})">${t.edit_btn}</button></div>
  </div>`;}
document.getElementById('res-items').innerHTML=html;
document.getElementById('result').classList.add('show');
setTimeout(()=>generateQR(buildOrderURL(S)),100);
}
function showFreeFormResult(){const t=T[S.lang];document.getElementById('main').classList.remove('show');document.getElementById('scr-names').classList.remove('show');document.querySelectorAll('.sub').forEach(s=>s.classList.remove('show'));const fb=document.getElementById('fin-btn');if(fb)fb.style.display='none';document.getElementById('result-title').textContent=t.result_title;document.getElementById('result-sub').textContent=t.result_sub;document.getElementById('ss-text').innerHTML=S.lang==='ja'?'QRã‚³ãƒ¼ãƒ‰ã‚’Kasuminã«èª­ã¿è¾¼ã‚“ã§ã‚‚ã‚‰ã£ã¦ã­ğŸ“±':'Show this QR code to KasuminğŸ“±';document.getElementById('restart-btn').textContent=t.restart_btn;let html='';html+=`<div class="res-row"><div class="res-icon">ğŸ‘¥</div><div><span class="res-label">${t.num_people_label}</span><span class="res-val">${S.numPlayers}${t.people_suffix}</span></div></div>`;html+=`<div class="res-row"><div class="res-icon">âœï¸</div><div><span class="res-label">${t.names_label}</span><span class="res-val">${S.names.join('ãƒ»')}</span></div></div>`;if(S.needTranslate)html+=`<div class="res-row"><div class="res-icon">ğŸŒ</div><div><span class="res-label">${t.translate_label}</span><span class="res-val">${t.translate_yes}</span></div></div>`;html+=`<div class="res-row"><div class="res-icon">âœ¨</div><div style="flex:1"><span class="res-label">${S.lang==='ja'?'è‡ªç”±ãƒªã‚¯ã‚¨ã‚¹ãƒˆ':'Free Request'}</span><span class="res-val" style="white-space:pre-wrap;" id="freeform-text-display">${S.freeFormText}</span></div><button class="edit-btn" onclick="copyFreeText()" id="copy-btn" style="white-space:nowrap;">${S.lang==='ja'?'ğŸ“‹ ã‚³ãƒ”ãƒ¼':'ğŸ“‹ Copy'}</button></div>`;if(S.freeFormTranslation)html+=`<div class="res-row"><div class="res-icon">ğŸ‡¯ğŸ‡µ</div><div><span class="res-label">${S.lang==='ja'?'ç¿»è¨³ï¼ˆè‡ªå‹•ï¼‰':'Translation (auto)'}</span><span class="res-val" style="white-space:pre-wrap;">${S.freeFormTranslation}</span></div></div>`;document.getElementById('res-items').innerHTML=html;document.getElementById('result').classList.add('show');setTimeout(()=>generateQR(buildOrderURL(S)),100);}
function copyFreeText(){const text=document.getElementById('freeform-text-display').textContent;navigator.clipboard.writeText(text).then(()=>{const btn=document.getElementById('copy-btn');const orig=btn.textContent;btn.textContent=S.lang==='ja'?'âœ“ ã‚³ãƒ”ãƒ¼æ¸ˆã¿':'âœ“ Copied!';btn.style.color='#ff9ec8';setTimeout(()=>{btn.textContent=orig;btn.style.color='';},2000);});}
function doRestart(){location.href=location.href.split('?')[0];}
function openSub(type){document.querySelectorAll('.sub').forEach(s=>s.classList.remove('show'));document.getElementById('free-area').classList.remove('show');document.getElementById('sub-'+type).classList.add('show');const t=T[S.lang];if(type==='bg'){renderMapSpots();setDialog('select_bg');}else if(type==='pet'){document.getElementById('pet-title').textContent=t.pet_title;document.getElementById('pet-back').textContent=t.back_btn;document.getElementById('pet-sub').innerHTML=t.pet_sub;document.getElementById('add-pet-btn').textContent=t.add_pet_btn;document.getElementById('pet-decide').textContent=t.decide_btn;document.getElementById('pet-label-1').textContent=t.pet_label+'1ã®åå‰';document.getElementById('pet-input-1').placeholder=t.pet_placeholder;setDialog('select_pet');}}
function closeSub(type){document.getElementById('sub-'+type).classList.remove('show');if(editingMode){editingMode=false;showResult();}else{setDialog('select_category');updateBadge(type);checkShowBtn();}}
function pickBg(btn,k){document.querySelectorAll('#bg-grid .opt-btn').forEach(b=>b.classList.remove('on'));btn.classList.add('on');S.bg=k;}
function openCostume(){currentPlayer=0;showCostumeForPlayer(0);document.getElementById('sub-costume').classList.add('show');document.getElementById('free-area').classList.remove('show');}
function showCostumeForPlayer(p){const t=T[S.lang];document.getElementById('costume-title').textContent=t.costume_title;document.getElementById('costume-back').textContent=t.back_btn;document.getElementById('section-costume-title').textContent=t.section_costume;document.getElementById('section-item-title').textContent=t.section_item;document.getElementById('costume-decide').textContent=t.decide_btn;document.getElementById('costume-player').textContent=t.name_label+(p+1)+'ï¼ˆ'+S.names[p]+'ï¼‰'+t.player_costume;const msg=S.names[p]+t.select_costume;document.getElementById('dtxt').innerHTML=msg+'<span class="blink">â–®</span>';const cg=document.getElementById('costume-grid');const ig=document.getElementById('item-grid');cg.innerHTML=Object.keys(COS).map(k=>{const c=COS[k];const on=S.costume[p].includes(k)?'on':'';return`<button class="opt-btn ${on}" onclick="pickCostume(${p},'${k}',this)"><span class="opt-e">${c.e}</span><span class="opt-l">${c[S.lang]}</span></button>`;}).join('');ig.innerHTML=Object.keys(ITM).map(k=>{const i=ITM[k];const on=S.item[p].includes(k)?'on':'';return`<button class="opt-btn ${on}" onclick="pickItem(${p},'${k}',this)"><span class="opt-e">${i.e}</span><span class="opt-l">${i[S.lang]}</span></button>`;}).join('');}
function pickCostume(p,k,btn){btn.classList.toggle('on');if(btn.classList.contains('on')){if(!S.costume[p].includes(k))S.costume[p].push(k);}else S.costume[p]=S.costume[p].filter(x=>x!==k);}
function pickItem(p,k,btn){btn.classList.toggle('on');if(btn.classList.contains('on')){if(!S.item[p].includes(k))S.item[p].push(k);}else S.item[p]=S.item[p].filter(x=>x!==k);}
function nextCostume(){if(editingMode){editingMode=false;document.getElementById('sub-costume').classList.remove('show');showResult();}else{currentPlayer++;if(currentPlayer<S.numPlayers)showCostumeForPlayer(currentPlayer);else{document.getElementById('sub-costume').classList.remove('show');setDialog('select_category');updateBadge('costume');checkShowBtn();}}}
function backCostume(){if(currentPlayer>0){currentPlayer--;showCostumeForPlayer(currentPlayer);}else{document.getElementById('sub-costume').classList.remove('show');setDialog('select_category');}}
function openMood(){currentPlayer=0;showMoodForPlayer(0);document.getElementById('sub-mood').classList.add('show');document.getElementById('free-area').classList.remove('show');}
function showMoodForPlayer(p){const t=T[S.lang];document.getElementById('mood-title').textContent=t.mood_title;document.getElementById('mood-back').textContent=t.back_btn;document.getElementById('mood-decide').textContent=t.decide_btn;document.getElementById('mood-player').textContent=t.name_label+(p+1)+'ï¼ˆ'+S.names[p]+'ï¼‰'+t.player_mood;const msg=S.names[p]+t.select_mood;document.getElementById('dtxt').innerHTML=msg+'<span class="blink">â–®</span>';const mg=document.getElementById('mood-grid');mg.innerHTML=Object.keys(MOOD).map(k=>{const m=MOOD[k];const on=S.mood[p].includes(k)?'on':'';return`<button class="opt-btn ${on}" onclick="pickMood(${p},'${k}',this)"><span class="opt-e">${m.e}</span><span class="opt-l">${m[S.lang]}</span></button>`;}).join('');}
function pickMood(p,k,btn){btn.classList.toggle('on');if(btn.classList.contains('on')){if(!S.mood[p].includes(k))S.mood[p].push(k);}else S.mood[p]=S.mood[p].filter(x=>x!==k);}
function nextMood(){if(editingMode){editingMode=false;document.getElementById('sub-mood').classList.remove('show');showResult();}else{currentPlayer++;if(currentPlayer<S.numPlayers)showMoodForPlayer(currentPlayer);else{document.getElementById('sub-mood').classList.remove('show');setDialog('select_category');updateBadge('mood');checkShowBtn();}}}
function backMood(){if(currentPlayer>0){currentPlayer--;showMoodForPlayer(currentPlayer);}else{document.getElementById('sub-mood').classList.remove('show');setDialog('select_category');}}
function addPet(){petCount++;const t=T[S.lang];const item=document.createElement('div');item.className='pet-item';item.innerHTML=`<label class="pet-label">${t.pet_label}${petCount}ã®åå‰</label><input type="text" class="pet-input" placeholder="${t.pet_placeholder}">`;document.getElementById('pet-list').appendChild(item);}
function updateBadge(type){let has=false;if(type==='costume')has=S.costume.some(a=>a.length>0)||S.item.some(a=>a.length>0);else if(type==='mood')has=S.mood.some(a=>a.length>0);else if(type==='pet'){const inputs=document.querySelectorAll('#pet-list .pet-input');has=Array.from(inputs).some(inp=>inp.value.trim()!=='');}else if(type==='bg')has=S.bg!=='';document.getElementById('card-'+type).classList.toggle('has-sel',has);document.getElementById('chk-'+type).textContent=has?'âœ“':'';}
function toggleFree(){const fa=document.getElementById('free-area');fa.classList.toggle('show');if(editingMode && !fa.classList.contains('show')){editingMode=false;document.getElementById('main').classList.remove('show');showResult();}else if(fa.classList.contains('show')){setDialog('select_free');}else{setDialog('select_category');checkShowBtn();}}
function checkShowBtn(){const hasPets=Array.from(document.querySelectorAll('#pet-list .pet-input')).some(inp=>inp.value.trim()!=='');const any=S.bg||S.costume.some(a=>a.length>0)||S.item.some(a=>a.length>0)||S.mood.some(a=>a.length>0)||hasPets||document.getElementById('free-input').value.trim();let fb=document.getElementById('fin-btn');if(!fb){fb=document.createElement('button');fb.style.cssText='position:absolute;bottom:8px;left:50%;transform:translateX(-50%);z-index:20;background:linear-gradient(135deg,#9060d0,#d060a0);border:none;border-radius:7px;color:white;font-family:"DotGothic16",monospace;font-size:12px;padding:10px 24px;cursor:pointer;box-shadow:0 4px 12px rgba(192,96,160,0.5);letter-spacing:0.1em;white-space:nowrap;';fb.id='fin-btn';fb.onclick=showResult;document.querySelector('.game-wrap').appendChild(fb);}const t=T[S.lang];fb.textContent=S.lang==='ja'?'âœ¦ ã‚ªãƒ¼ãƒ€ãƒ¼ç¢ºå®š âœ¦':'âœ¦ Confirm Order âœ¦';fb.style.display=any?'block':'none';}
function editNames(){editingMode=true;document.getElementById('result').classList.remove('show');document.getElementById('main').classList.remove('show');document.querySelectorAll('.sub').forEach(s=>s.classList.remove('show'));document.getElementById('free-area').classList.remove('show');document.getElementById('scr-names').classList.add('show');const t=T[S.lang];document.getElementById('name-title').textContent=t.name_title;document.getElementById('name-sub').textContent=t.name_sub;document.getElementById('translate-check').textContent=t.translate_check;document.getElementById('name-next').textContent=t.next_btn;const list=document.getElementById('name-list');list.innerHTML='';for(let i=0;i<S.numPlayers;i++){list.innerHTML+=`<div class="name-item"><label class="name-label">${t.name_label}${i+1}</label><input type="text" class="name-input" id="name-${i}" placeholder="${t.name_placeholder}" value="${S.names[i]}"></div>`;}document.getElementById('need-translate').checked=S.needTranslate;}
function editBg(){editingMode=true;document.getElementById('result').classList.remove('show');document.getElementById('main').classList.remove('show');document.getElementById('scr-names').classList.remove('show');document.getElementById('free-area').classList.remove('show');openSub('bg');document.getElementById('sub-bg').classList.add('show');}
function editCostume(p){editingMode=true;currentPlayer=p;document.getElementById('result').classList.remove('show');document.getElementById('main').classList.remove('show');document.getElementById('scr-names').classList.remove('show');document.getElementById('free-area').classList.remove('show');showCostumeForPlayer(p);document.getElementById('sub-costume').classList.add('show');}
function editMood(p){editingMode=true;currentPlayer=p;document.getElementById('result').classList.remove('show');document.getElementById('main').classList.remove('show');document.getElementById('scr-names').classList.remove('show');document.getElementById('free-area').classList.remove('show');showMoodForPlayer(p);document.getElementById('sub-mood').classList.add('show');}
function editPet(){editingMode=true;document.getElementById('result').classList.remove('show');document.getElementById('main').classList.remove('show');document.getElementById('scr-names').classList.remove('show');document.getElementById('free-area').classList.remove('show');const t=T[S.lang];document.getElementById('pet-title').textContent=t.pet_title;document.getElementById('pet-back').textContent=t.back_btn;document.getElementById('pet-sub').innerHTML=t.pet_sub;document.getElementById('add-pet-btn').textContent=t.add_pet_btn;document.getElementById('pet-decide').textContent=t.decide_btn;const list=document.getElementById('pet-list');list.innerHTML='';petCount=0;if(S.pets.length===0){petCount=1;list.innerHTML=`<div class="pet-item"><label class="pet-label">${t.pet_label}1ã®åå‰</label><input type="text" class="pet-input" placeholder="${t.pet_placeholder}"></div>`;}else{S.pets.forEach((name,i)=>{petCount=i+1;const item=document.createElement('div');item.className='pet-item';item.innerHTML=`<label class="pet-label">${t.pet_label}${i+1}ã®åå‰</label><input type="text" class="pet-input" placeholder="${t.pet_placeholder}" value="${name}">`;list.appendChild(item);});}document.getElementById('sub-pet').classList.add('show');}
function editFree(){editingMode=true;document.getElementById('result').classList.remove('show');document.getElementById('scr-names').classList.remove('show');document.querySelectorAll('.sub').forEach(s=>s.classList.remove('show'));renderMainScreen();document.getElementById('main').classList.add('show');document.getElementById('free-area').classList.add('show');}
function generateQR(url){const wrap=document.getElementById('qr-wrap');wrap.innerHTML='';new QRCode(wrap,{text:url,width:140,height:140,colorDark:'#1a0a2e',colorLight:'#ffffff',correctLevel:QRCode.CorrectLevel.M});}
function buildOrderURL(data){const base=location.href.split('?')[0];const p=new URLSearchParams();p.set('v','1');if(data.lang)p.set('l',data.lang);if(data.numPlayers)p.set('n',data.numPlayers);if(data.names&&data.names.length)p.set('nm',data.names.join(','));if(data.needTranslate)p.set('tr','1');if(data.bg)p.set('bg',data.bg);if(data.costume&&data.costume.some(a=>a.length))p.set('co',data.costume.map(a=>a.join('+')).join('|'));if(data.item&&data.item.some(a=>a.length))p.set('it',data.item.map(a=>a.join('+')).join('|'));if(data.mood&&data.mood.some(a=>a.length))p.set('mo',data.mood.map(a=>a.join('+')).join('|'));if(data.pets&&data.pets.length)p.set('pt',data.pets.join(','));if(data.free)p.set('fr',data.free);if(data.freeFormText)p.set('ff',data.freeFormText);return base+'?'+p.toString();}
function loadFromURL(){const p=new URLSearchParams(location.search);if(!p.get('v'))return false;S.lang=p.get('l')||'ja';S.numPlayers=parseInt(p.get('n'))||1;S.names=(p.get('nm')||'').split(',').filter(Boolean);S.needTranslate=p.get('tr')==='1';S.bg=p.get('bg')||'';S.costume=(p.get('co')||'').split('|').map(s=>s?s.split('+').filter(Boolean):[]);S.item=(p.get('it')||'').split('|').map(s=>s?s.split('+').filter(Boolean):[]);S.mood=(p.get('mo')||'').split('|').map(s=>s?s.split('+').filter(Boolean):[]);S.pets=(p.get('pt')||'').split(',').filter(Boolean);S.free=p.get('fr')||'';S.freeFormText=p.get('ff')||'';if(S.freeFormText)showFreeFormResult();else showResult();return true;}
window.addEventListener('load',()=>{if(!loadFromURL()){document.getElementById('scr-lang').classList.add('show');}});
</script>

</body>
</html>